# validation

Alt text validation and sanitization utilities.

**Module:** `main/utils/validation`  
**Source:** [src/main/utils/validation.js](../src/main/utils/validation.js)

## Overview

This module provides accessibility-focused validation for image alt text:

- Length validation
- Forbidden prefix detection
- Quality checks (AI mentions, filenames, keyword stuffing)
- Sanitization for fixing common issues

---

## Type Definitions

### ValidationResult

Result of alt text validation.

```typescript
interface ValidationResult {
  /** Whether the alt text passes all validation rules */
  valid: boolean
  /** List of validation issues found */
  issues: string[]
  /** The trimmed input text */
  text: string
}
```

---

## Constants

### FORBIDDEN_PREFIXES

Prefixes that reduce accessibility by being redundant for screen readers.

```javascript
const FORBIDDEN_PREFIXES = [
  'image of',
  'picture of',
  'photo of',
  'photograph of',
  'a image',
  'an image',
  'a photo',
  'an photo',
  'a picture',
  'an picture',
]
```

---

## Functions

### validateAltText(text, maxLength)

Validates alt text against accessibility best practices.

```javascript
import { validateAltText } from './utils/validation.js'

const result = validateAltText('A golden retriever playing fetch in the park')

if (result.valid) {
  console.log('Alt text is valid')
} else {
  console.log('Issues:', result.issues)
}
```

**Parameters:**

| Name | Type | Default | Description |
|------|------|---------|-------------|
| `text` | `string \| undefined` | — | Alt text to validate |
| `maxLength` | `number` | `125` | Maximum allowed character length |

**Returns:** `ValidationResult`

---

### Validation Rules

| Rule | Issue Message |
|------|---------------|
| Missing alt text | `'Missing alt text'` |
| Not a string | `'Alt text must be a string'` |
| Too long | `'Exceeds {maxLength} characters ({actual})'` |
| Forbidden prefix | `'Starts with forbidden prefix: "{prefix}"'` |
| Contains extension | `'Contains file extension'` |
| AI mention | `'Contains AI mention'` |
| Appears to be filename | `'Appears to be a filename'` |
| Keyword stuffing | `'Possible keyword stuffing detected'` |

---

### Validation Examples

```javascript
// Valid
validateAltText('A cat sitting on a windowsill')
// { valid: true, issues: [], text: 'A cat sitting on a windowsill' }

// Too long
validateAltText('A'.repeat(150), 125)
// { valid: false, issues: ['Exceeds 125 characters (150)'], text: '...' }

// Forbidden prefix
validateAltText('Image of a sunset')
// { valid: false, issues: ['Starts with forbidden prefix: "image of"'], text: '...' }

// Contains extension
validateAltText('sunset-beach.jpg photo')
// { valid: false, issues: ['Contains file extension'], text: '...' }

// AI mention
validateAltText('Description generated by ChatGPT')
// { valid: false, issues: ['Contains AI mention'], text: '...' }

// Filename pattern
validateAltText('IMG_2024')
// { valid: false, issues: ['Appears to be a filename'], text: '...' }

// Keyword stuffing
validateAltText('shoes shoes shoes buy shoes best shoes')
// { valid: false, issues: ['Possible keyword stuffing detected'], text: '...' }
```

---

### sanitizeAltText(text, maxLength)

Sanitizes alt text by removing forbidden prefixes and ensuring proper formatting.

```javascript
import { sanitizeAltText } from './utils/validation.js'

sanitizeAltText('image of a sunset over the ocean')
// 'Sunset over the ocean'

sanitizeAltText('photo of: mountains in winter')
// 'Mountains in winter'

sanitizeAltText('A'.repeat(150), 125)
// 'AAAA...A…' (truncated with ellipsis)
```

**Parameters:**

| Name | Type | Default | Description |
|------|------|---------|-------------|
| `text` | `string \| undefined` | — | Alt text to sanitize |
| `maxLength` | `number` | `125` | Maximum allowed character length |

**Returns:** `string` — Sanitized alt text

---

### Sanitization Steps

1. **Trim** — Remove leading/trailing whitespace
2. **Remove prefix** — Strip forbidden prefix if present
3. **Clean separator** — Remove leading comma/colon after prefix removal
4. **Capitalize** — Ensure first character is uppercase
5. **Truncate** — Add ellipsis if exceeds max length

---

## Regex Patterns

### File Extension Detection

```javascript
/\.(jpg|jpeg|png|gif|webp|svg|bmp|tiff?)/i
```

Matches common image file extensions in the text.

### AI Mention Detection

```javascript
/generated by ai|ai-generated|chatgpt|copilot|gpt-4|claude/i
```

Matches common AI tool references.

### Filename Pattern Detection

```javascript
/^\w+[-_]\d+$/i
```

Matches patterns like `IMG_2024`, `photo-001`.

### Keyword Stuffing Detection

Words longer than 3 characters appearing more than 2 times are flagged.

---

## Usage Example

### In Copilot Adapter

```javascript
import { validateAltText } from './utils/validation.js'
import { generateAltText } from './services/copilot-adapter.js'

async function getValidatedAltText(imagePath) {
  const result = await generateAltText(imagePath, { maxLength: 125 })
  
  const validation = validateAltText(result.altText, 125)
  
  return {
    altText: result.altText,
    valid: validation.valid,
    issues: validation.issues
  }
}
```

### Pre-Save Validation

```javascript
import { validateAltText, sanitizeAltText } from './utils/validation.js'

async function saveAltText(mediaId, proposedAlt, maxLength = 125) {
  const validation = validateAltText(proposedAlt, maxLength)
  
  if (!validation.valid) {
    // Try to sanitize
    const sanitized = sanitizeAltText(proposedAlt, maxLength)
    
    const revalidation = validateAltText(sanitized, maxLength)
    if (!revalidation.valid) {
      throw new Error(`Cannot fix alt text: ${revalidation.issues.join(', ')}`)
    }
    
    return wpClient.updateAltText(mediaId, sanitized)
  }
  
  return wpClient.updateAltText(mediaId, proposedAlt)
}
```
